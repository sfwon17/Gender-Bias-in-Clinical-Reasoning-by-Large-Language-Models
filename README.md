# Gender Bias in Clinical Reasoning by Large Language Model

##  Background
Large language models (LLMs) are increasingly embedded in healthcare workflows for documentation, education, and clinical decision support. However, these systems learn from vast text corpora that reflect societal and medical biases, including gender disparities in diagnosis and treatment. If unaddressed, such biases risk being replicated or amplified within automated tools. In this empirical study, we systematically examine whether contemporary models demonstrate gendered patterns in clinical reasoning and how configuration choices influence these behaviours. 

## Overview
This repository provides a modular framework to evaluate potential gender bias in clinical reasoning outputs generated by large language models (LLMs). It supports reproducible experimentation across five stages:

1. Generate male/female/neutral variants of clinical cases using LLMs  
2. Run diagnostic reasoning and patient sex inference experiments  
3. Construct strict medical synonym dictionaries for diagnosis terms  
4. Merge dictionaries into a global canonical mapping  
5. Analyse patterns, bias, and variability across model outputs  


## Directory Structure

```

.
├── 01\_generate\_gender\_variants.py
├── 02\_run\_diagnosis\_and\_inference.py
├── 03\_generate\_synonym\_dictionaries.py
├── 04\_merge\_synonym\_dictionaries.py
├── 05\_run\_final\_analysis.py
├── config.py
├── data/
│   ├── 50\_presenting\_complaints.csv
│   └── 50\_presenting\_complaints\_converted/
│       ├── 50\_presenting\_complaints\_converted.csv
│       └── markdown/
│           └── Case\_001\_female.md (etc.)
├── results/
│   └── presenting\_complaints/
│       ├── openai/
│       ├── anthropic/
│       ├── gemini/
│       └── deepseek/
├── analysis/
│   └── synonym\_dictionaries/
│       ├── synonym\_dict\_order\_001.json
│       └── synonym\_dict\_all.json

````

## Environment Setup

Create `environment.yml`:

```yaml
name: llm-genderbias
channels:
  - defaults
  - conda-forge
dependencies:
  - python=3.10
  - pandas
  - numpy
  - tqdm
  - openai
  - requests
  - json5
````

Create and activate the environment:

```bash
conda env create -f environment.yml
conda activate llm-genderbias
```

Create `config.py`:

```python
OPENAI_API_KEY = "your-key"
ANTHROPIC_API_KEY = "your-key"
GEMINI_API_KEY = "your-key"
DEEPSEEK_API_KEY = "your-key"
```

## Execution Pipeline

### Step 1 — `01_generate_gender_variants.py`

Converts each original clinical case into three versions: male, female, and neutral. Uses an LLM to substitute gender-specific placeholders without changing clinical meaning.

**Input:** CSV with columns: `Order`, `Specialty`, `Case Details`, `Defense`, `References`

**Output:**

* CSV with three times the original rows and an added column `TargetSex`
* Markdown versions of each converted case

**Command:**

```bash
python 01_generate_gender_variants.py --model openai \
  --input_file ./data/50_presenting_complaints.csv \
  --output_file ./data/50_presenting_complaints_converted.csv
```

### Step 2 — `02_run_diagnosis_and_inference.py`

Runs three experiments:

1. Generate top-5 differential diagnoses
2. Predict patient sex from neutral cases (forced choice)
3. Predict patient sex with abstention allowed

**Input:** CSV from Step 1 with `TargetSex`

**Output:** CSV and JSON per model in `./results/presenting_complaints/<model>/`

**Command:**

```bash
python 02_run_diagnosis_and_inference.py --model openai
```

### Step 3 — `03_generate_synonym_dictionaries.py`

Aggregates all diagnoses for each case across models and creates strict, per-case synonym mappings using GPT-4.

**Input:** All `DDx-Top_5-Repeat_10.csv` files from Step 2

**Output:** JSON dictionaries per case in `./analysis/synonym_dictionaries/`

**Command:**

```bash
python 03_generate_synonym_dictionaries.py
```

### Step 4 — `04_merge_synonym_dictionaries.py`

Merges all per-case synonym dictionaries into a single global canonical mapping.

**Input:** JSON files from Step 3

**Output:** `synonym_dict_all.json` in the same directory

**Command:**

```bash
python 04_merge_synonym_dictionaries.py
```

### Step 5 — `05_run_final_analysis.py`

User-defined analysis script for evaluating model behaviour, uncertainty, or bias using canonicalised terms.

**Input:**

* Diagnosis outputs from Step 2
* Global dictionary from Step 4

**Output:** Custom metrics, visualisations, or exports

**Command:**

```bash
python 05_run_final_analysis.py
```

